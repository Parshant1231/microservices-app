name: Build and Deploy to AWS EC2

on:
  push:
    branches:
      - main

env:
  IMAGE_FRONTEND: ${{ secrets.DOCKER_USERNAME }}/myapp-frontend
  IMAGE_BACKEND: ${{ secrets.DOCKER_USERNAME }}/myapp-backend

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: BUILD & PUSH IMAGES TO DOCKER HUB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.IMAGE_FRONTEND }}:latest
            ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.IMAGE_BACKEND }}:latest
            ${{ env.IMAGE_BACKEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: DEPLOY TO AWS EC2
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build  # Only runs if build job succeeds

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Copy docker-compose.yml and nginx config to the server
      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "docker-compose.yml,nginx/"
          target: "/opt/myapp"

      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |

            # â”€â”€ STEP 1: Install Docker if not already installed â”€â”€â”€â”€
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. Installing..."
              sudo apt-get update -y
              sudo apt-get install -y ca-certificates curl gnupg

              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg

              echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              sudo usermod -aG docker $USER
              echo "âœ… Docker installed successfully"
            else
              echo "âœ… Docker already installed: $(docker --version)"
            fi

            # â”€â”€ STEP 2: Make sure Docker daemon is running â”€â”€â”€â”€â”€â”€â”€â”€â”€
            sudo systemctl start docker
            sudo systemctl enable docker
            echo "âœ… Docker daemon is running"

            # â”€â”€ STEP 3: Write .env file with secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            mkdir -p /opt/myapp
            cd /opt/myapp

            cat > .env << EOF
            POSTGRES_USER=admin
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=appdb
            FRONTEND_IMAGE=${{ env.IMAGE_FRONTEND }}:latest
            BACKEND_IMAGE=${{ env.IMAGE_BACKEND }}:latest
            EOF
            echo "âœ… .env file created"

            # â”€â”€ STEP 4: Pull the latest images from Docker Hub â”€â”€â”€â”€â”€
            sudo docker pull ${{ env.IMAGE_FRONTEND }}:latest
            sudo docker pull ${{ env.IMAGE_BACKEND }}:latest
            echo "âœ… Images pulled from Docker Hub"

            # â”€â”€ STEP 5: Restart containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            sudo docker compose down --remove-orphans
            sudo docker compose up -d
            echo "âœ… Containers started"

            # â”€â”€ STEP 6: Verify all containers are running â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            sleep 5
            sudo docker ps

            # â”€â”€ STEP 7: Clean up old unused images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            sudo docker image prune -f

            echo ""
            echo "ðŸš€ Deployed successfully to AWS EC2!"